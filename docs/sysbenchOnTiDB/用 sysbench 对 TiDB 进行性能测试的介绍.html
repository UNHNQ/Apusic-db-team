<html>
<head>
  <title>用 sysbench 对 TiDB 进行性能测试的介绍</title>
  <basefont face="宋体" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306770 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 宋体;
      font-size: 11pt;
    }
  </style>
</head>
<body>
<a name="10666"/>
<h1>用 sysbench 对 TiDB 进行性能测试的介绍</h1>

<div>
<span><div><div>sysbench是基于LuaJIT的脚步化多线程的基准测试工具，最常用于数据库基准测试，但也可用于创建不涉及数据库服务器的任意复杂的工作负载。</div><div>sysbench内置了一些测试cpu、文件系统、内存、线程调度器、POSIX mutex等等的 benchmark，可以直接调用进行测试。还有一些可定制的lua脚本，比如完成oltp测试的lua脚本就是执行一些SQL语句，完成点查、范围查、排序查、SELECT DISTINCT、更新、删除、插入等一系列组合的测试。</div><div><br/></div><div>特点：</div><ul style="box-sizing: border-box; padding-left: 2em; margin-top: 0px; margin-bottom: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><li style="box-sizing: border-box;">关于比率和响应时间有广泛的统计数据可用，包括响应时间百分比和直方图;</li><li style="box-sizing: border-box; margin-top: 0.25em;">即使有数千个并发线程，开销也很低。sysbench能够每秒生成和跟踪数以亿计的事件（即请求）;</li><li style="box-sizing: border-box; margin-top: 0.25em;">通过在用户提供的Lua脚本中实现预定义的钩子，可以轻松创建新的基准;</li><li style="box-sizing: border-box; margin-top: 0.25em;">可以作为一个通用的Lua解释器，只需在脚本中用 #!/usr/bin/sysbench 替换 #!/usr/bin/lua。</li></ul><div>默认自带下列基准测试：</div><ul style="box-sizing: border-box; padding-left: 2em; margin-top: 0px; margin-bottom: 16px; font-size: 16px; letter-spacing: normal; orphans: 2; text-align: start; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px;"><li style="box-sizing: border-box;">oltp_*.lua: a collection of OLTP-like database benchmarks</li><li style="box-sizing: border-box; margin-top: 0.25em;">fileio: a filesystem-level benchmark</li><li style="box-sizing: border-box; margin-top: 0.25em;">cpu: a simple CPU benchmark</li><li style="box-sizing: border-box; margin-top: 0.25em;">memory: a memory access benchmark</li><li style="box-sizing: border-box; margin-top: 0.25em;">threads: a thread-based scheduler benchmark</li><li style="box-sizing: border-box; margin-top: 0.25em;">mutex: a POSIX mutex benchmark</li></ul><div>响应时间直方图的例子：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Threads started!</div><div><br/></div><div>[ 10s ] thds: 256 tps: 1137.91 qps: 23012.82 (r/w/o: 16150.14/4562.45/2300.22) lat (ms,95%): 287.38 err/s: 0.00 reconn/s: 0.00</div><div>[ 20s ] thds: 256 tps: 1202.42 qps: 24049.33 (r/w/o: 16838.93/4806.07/2404.33) lat (ms,95%): 282.25 err/s: 0.00 reconn/s: 0.00</div><div>[ 30s ] thds: 256 tps: 1221.92 qps: 24430.12 (r/w/o: 17096.70/4889.48/2443.94) lat (ms,95%): 277.21 err/s: 0.00 reconn/s: 0.00</div><div>Latency histogram (values are in milliseconds)</div><div>       value  ------------- distribution ------------- count</div><div>      54.828 |                                         1</div><div>      63.323 |                                         1</div><div>      65.645 |                                         1</div><div>      68.053 |                                         2</div><div>      70.548 |                                         2</div><div>      71.830 |                                         3</div><div>      75.817 |                                         2</div><div>      77.194 |                                         1</div><div>      78.597 |                                         5</div><div>      80.025 |                                         3</div><div>      81.479 |                                         3</div><div>      82.959 |                                         3</div><div>      84.467 |                                         6</div><div>      86.002 |                                         3</div><div>      87.564 |                                         10</div><div>      89.155 |                                         7</div><div>      90.775 |                                         13</div><div>      92.424 |                                         14</div><div>      94.104 |                                         15</div><div>      95.814 |                                         12</div><div>      97.555 |                                         13</div><div>      99.327 |                                         13</div><div>     101.132 |                                         16</div><div>     102.969 |                                         12</div><div>     104.840 |*                                        24</div><div>     106.745 |*                                        28</div><div>     108.685 |*                                        32</div><div>     110.659 |*                                        39</div><div>     112.670 |*                                        52</div><div>     114.717 |*                                        47</div><div>     116.802 |**                                       78</div><div>     118.924 |**                                       74</div><div>     121.085 |**                                       67</div><div>     123.285 |**                                       83</div><div>     125.525 |***                                      96</div><div>     127.805 |****                                     134</div><div>     130.128 |****                                     140</div><div>     132.492 |****                                     146</div><div>     134.899 |*****                                    181</div><div>     137.350 |******                                   196</div><div>     139.846 |*******                                  235</div><div>     142.387 |******                                   224</div><div>     144.974 |*******                                  241</div><div>     147.608 |********                                 276</div><div>     150.290 |*********                                325</div><div>     153.021 |***********                              405</div><div>     155.801 |***********                              377</div><div>     158.632 |************                             431</div><div>     161.514 |************                             429</div><div>     164.449 |***************                          533</div><div>     167.437 |****************                         554</div><div>     170.479 |****************                         567</div><div>     173.577 |******************                       657</div><div>     176.731 |********************                     727</div><div>     179.942 |***********************                  802</div><div>     183.211 |*********************                    758</div><div>     186.540 |***********************                  832</div><div>     189.929 |****************************             1009</div><div>     193.380 |****************************             1011</div><div>     196.894 |***************************              965</div><div>     200.472 |******************************           1086</div><div>     204.114 |*********************************        1164</div><div>     207.823 |**********************************       1194</div><div>     211.599 |************************************     1270</div><div>     215.443 |*************************************    1331</div><div>     219.358 |*************************************    1316</div><div>     223.344 |**************************************   1366</div><div>     227.402 |**************************************** 1425</div><div>     231.534 |************************************     1292</div><div>     235.740 |***********************************      1260</div><div>     240.024 |***********************************      1251</div><div>     244.385 |*******************************          1095</div><div>     248.825 |******************************           1070</div><div>     253.346 |******************************           1074</div><div>     257.950 |*************************                906</div><div>     262.636 |************************                 856</div><div>     267.408 |*********************                    755</div><div>     272.267 |****************                         574</div><div>     277.214 |***************                          552</div><div>     282.251 |************                             441</div><div>     287.379 |**********                               342</div><div>     292.601 |*******                                  254</div><div>     297.917 |*******                                  253</div><div>     303.330 |*****                                    161</div><div>     308.842 |***                                      114</div><div>     314.453 |***                                      100</div><div>     320.167 |**                                       65</div><div>     325.984 |**                                       54</div><div>     331.907 |*                                        34</div><div>     337.938 |*                                        31</div><div>     344.078 |*                                        47</div><div>     350.330 |*                                        32</div><div>     356.695 |*                                        27</div><div>     363.176 |*                                        22</div><div>     369.775 |*                                        20</div><div>     376.494 |*                                        23</div><div>     383.334 |                                         12</div><div>     390.299 |                                         8</div><div>     397.391 |                                         6</div><div>     404.611 |                                         11</div><div>     411.963 |                                         4</div><div>     419.448 |                                         5</div><div>     427.069 |                                         4</div><div>     434.829 |                                         1</div><div>     442.730 |                                         1</div><div>     458.964 |                                         1</div><div>    1129.239 |                                         1</div><div>    1149.757 |                                         1</div><div>    1170.648 |                                         5</div><div>    1191.918 |                                         3</div><div>    1213.575 |                                         4</div><div>    1235.625 |                                         6</div><div>    1258.076 |                                         10</div><div>    1304.208 |                                         3</div><div>    1327.905 |                                         1</div><div>    5312.729 |                                         1</div></div><div><br/></div><div>sysbench默认带了如下数据库测试脚本：</div><div><img src="用 sysbench 对 TiDB 进行性能测试的介绍_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>可以直接调用脚本对数据库进行压测：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>$ sysbench /usr/share/sysbench/oltp_read_only.lua \</div><div>--mysql-host=127.0.0.1 \</div><div>--mysql-port=3306 \</div><div>--mysql-user=root \</div><div>--mysql-password='000000' \</div><div>--mysql-db=sbtest \</div><div>--db-driver=mysql \</div><div>--tables=10 \</div><div>--table-size=1000000 \</div><div>--report-interval=10 \</div><div>--threads=128 \</div><div>--time=120 \</div><div>run</div></div><div><br/></div><div>一个30秒的oltp测试结果展示：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Initializing worker threads...</div><div><br/></div><div>Threads started!</div><div><br/></div><div>[ 10s ] thds: 256 tps: 1137.91 qps: 23012.82 (r/w/o: 16150.14/4562.45/2300.22) lat (ms,95%): 287.38 err/s: 0.00 reconn/s: 0.00</div><div>[ 20s ] thds: 256 tps: 1202.42 qps: 24049.33 (r/w/o: 16838.93/4806.07/2404.33) lat (ms,95%): 282.25 err/s: 0.00 reconn/s: 0.00</div><div>[ 30s ] thds: 256 tps: 1221.92 qps: 24430.12 (r/w/o: 17096.70/4889.48/2443.94) lat (ms,95%): 277.21 err/s: 0.00 reconn/s: 0.00</div><div><br/></div><div>SQL statistics:</div><div>    queries performed:</div><div>        read:                            502334</div><div>        write:                           143524</div><div>        other:                           71762</div><div>        total:                           717620</div><div>    transactions:                        35881  (1128.64 per sec.)</div><div>    queries:                             717620 (22572.85 per sec.)</div><div>    ignored errors:                      0      (0.00 per sec.)</div><div>    reconnects:                          0      (0.00 per sec.)</div><div><br/></div><div>General statistics:</div><div>    total time:                          31.7877s</div><div>    total number of events:              35881</div><div><br/></div><div>Latency (ms):</div><div>         min:                                 54.55</div><div>         avg:                                214.67</div><div>         max:                               5344.86</div><div>         95th percentile:                    282.25</div><div>         sum:                            7702745.81</div><div><br/></div><div>Threads fairness:</div><div>    events (avg/stddev):           140.1602/2.99</div><div>    execution time (avg/stddev):   30.0889/0.11</div></div><div><br/></div><div>*. 对磁盘io进行压测的例子：</div><div>先准备要测试的文件：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[tidb@rds1 sysbench]$ sysbench fileio --file-num=16 --file-total-size=2G prepare</div><div>sysbench 1.0.12 (using bundled LuaJIT 2.1.0-beta2)</div><div><br/></div><div>16 files, 131072Kb each, 2048Mb total</div><div>Creating files for the test...</div><div>Extra file open flags: 3</div><div>Creating file test_file.0</div><div>Creating file test_file.1</div><div>Creating file test_file.2</div><div>Creating file test_file.3</div><div>Creating file test_file.4</div><div>Creating file test_file.5</div><div>Creating file test_file.6</div><div>Creating file test_file.7</div><div>Creating file test_file.8</div><div>Creating file test_file.9</div><div>Creating file test_file.10</div><div>Creating file test_file.11</div><div>Creating file test_file.12</div><div>Creating file test_file.13</div><div>Creating file test_file.14</div><div>Creating file test_file.15</div><div>2147483648 bytes written in 5.52 seconds (371.28 MiB/sec).</div></div><div><br/></div><div>在性能测试服务器【Intel(R) Xeon(R) CPU E5-2640 v4 @ 2.40GHz，40核/256G内存/SSD硬盘】上的测试结果展示：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[tidb@rds1 sysbench]$ sysbench fileio --time=60 --events=100000000 --threads=16 --file-num=16 --file-total-size=2G --file-test-mode=rndrd --file-extra-flags=direct --file-fsync-freq=0 --file-block-size=16384 run</div><div>sysbench 1.0.12 (using bundled LuaJIT 2.1.0-beta2)</div><div><br/></div><div>Running the test with following options:</div><div>Number of threads: 16</div><div>Initializing random number generator from current time</div><div><br/></div><div><br/></div><div>Extra file open flags: 3</div><div>16 files, 128MiB each</div><div>2GiB total file size</div><div>Block size 16KiB</div><div>Number of IO requests: 100000000</div><div>Read/Write ratio for combined random IO test: 1.50</div><div>Calling fsync() at the end of test, Enabled.</div><div>Using synchronous I/O mode</div><div>Doing random read test</div><div>Initializing worker threads...</div><div><br/></div><div>Threads started!</div><div><br/></div><div><br/></div><div>File operations:</div><div>    reads/s:                      68278.84</div><div>    writes/s:                     0.00</div><div>    fsyncs/s:                     0.00</div><div><br/></div><div>Throughput:</div><div>    read, MiB/s:                  1066.86</div><div>    written, MiB/s:               0.00</div><div><br/></div><div>General statistics:</div><div>    total time:                          60.0003s</div><div>    total number of events:              4097004</div><div><br/></div><div>Latency (ms):</div><div>         min:                                  0.03</div><div>         avg:                                  0.23</div><div>         max:                                 19.05</div><div>         95th percentile:                      0.32</div><div>         sum:                             957873.75</div><div><br/></div><div>Threads fairness:</div><div>    events (avg/stddev):           256062.7500/426.01</div><div>    execution time (avg/stddev):   59.8671/0.00</div></div><div><br/></div><div>作为对比，同样的测试，在一台很普通的机器【Intel(R) Core(TM) i5-7500 CPU @ 3.40GHz，4核/8G内存/机械硬盘】上的测试结果：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>[root@rdsclient testsysbench]# sysbench fileio --time=60 --events=100000000 --threads=16 --file-num=16 --file-total-size=2G --file-test-mode=rndrd --file-extra-flags=direct --file-fsync-freq=0 --file-block-size=16384 run</div><div>sysbench 1.0.12 (using bundled LuaJIT 2.1.0-beta2)</div><div><br/></div><div>Running the test with following options:</div><div>Number of threads: 16</div><div>Initializing random number generator from current time</div><div><br/></div><div><br/></div><div>Extra file open flags: 3</div><div>16 files, 128MiB each</div><div>2GiB total file size</div><div>Block size 16KiB</div><div>Number of IO requests: 100000000</div><div>Read/Write ratio for combined random IO test: 1.50</div><div>Calling fsync() at the end of test, Enabled.</div><div>Using synchronous I/O mode</div><div>Doing random read test</div><div>Initializing worker threads...</div><div><br/></div><div>Threads started!</div><div><br/></div><div><br/></div><div>File operations:</div><div>    reads/s:                      326.51</div><div>    writes/s:                     0.00</div><div>    fsyncs/s:                     0.00</div><div><br/></div><div>Throughput:</div><div>    read, MiB/s:                  5.10</div><div>    written, MiB/s:               0.00</div><div><br/></div><div>General statistics:</div><div>    total time:                          60.0693s</div><div>    total number of events:              19614</div><div><br/></div><div>Latency (ms):</div><div>         min:                                  0.19</div><div>         avg:                                 48.96</div><div>         max:                                782.61</div><div>         95th percentile:                    164.45</div><div>         sum:                             960341.01</div><div><br/></div><div>Threads fairness:</div><div>    events (avg/stddev):           1225.8750/48.05</div><div>    execution time (avg/stddev):   60.0213/0.02</div></div><div><br/></div><div>*. 本次TiDB sysbench测试步骤</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>*. 修改 pingcap/tidb-bench/sysbench/conf.sh 中的参数</div><div>*. （可选）如果修改了表数或表中的数据行数，可能需要重新准备数据</div><div>    cleanup.sh</div><div>    parallel-prepare.sh</div><div>*. （可选）如果修改了tidb的参数，需要重启 TiDB，在 172.20.129.11 的 /tidb/tidb-ansible-master 目录执行：</div><div>    ansible-playbook stop.yml</div><div>    ansible-playbook start.yml</div><div>**. 【重要】 在所有机器上修改 ~/bin/testname 文件，写入当前测试的名字，比如：tidb_16x100w_256t</div><div>*. 在所有机器上以“tidb” 用户（比如可以用：su - tidb转换到tidb用户）同时运行 nmon.sh，启动nmon监控（默认配置10分钟，到时会自动停止）。</div><div>*. 紧接着（尽量缩短时间），在所有运行sysbench客户端的机器上以“tidb” 用户sysbench目录下同时运行测试脚本，比如 ./oltp.sh | tee $(teen)</div><div>*. 大约10分钟后（测试时间，可配置），测试结束，在 windows 机器上保存测试结果的目录中运行 cptr.bat，把测试结果一键拷贝到 windows机器：</div><div>   例如： cptr 20180211-102 （会调用 pscp 拷贝所有测试机 ~/nmon 目录中名字符合 *20180211-102* 的所有 .nmon 文件和 .log文件）</div><div>*. 如需要分析结果可用 nmon analyser v52_1.xlsm 把 .nmon 文件转换成 Excel 图表。</div><div>*. 测试数据量大的时候要注意监控硬盘的空间，如果不够，需要扩容TiKV。</div></div><div><br/></div><div>Grafana 显示的目前总体空间占用（32 x 500万行数据）</div><div><img src="用 sysbench 对 TiDB 进行性能测试的介绍_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>每个TiKV的占用情况：</div><div><img src="用 sysbench 对 TiDB 进行性能测试的介绍_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div>*. 测试过程中的一些非正式记录：</div><div>准备 16个表*100万行数据，</div><div>调用parallel-prepare并行准备数据: TiDB 需要6分钟(带宽平均80MBit/s)，Mysql主需要不到一分钟，算上三个从都同步完的时间总共也就2分钟的事(带宽平均445MBit/s)。</div><div>调用prepare串行准备数据：TiDB 需要20分钟以上（带宽用到20MBit/s），Mysql不到5分钟(带宽用到91MBit/s)</div><div><br/></div><div>关掉 Mysql 半同步，采用异步复制，性能能提高 20-30%:</div><div>20180212-101010_rdsclient_mysql_16_100w_256t_async：tps：1404.02</div><div><br/></div><div>再设置 innodb_flush_log_at_trx_commit = 0，又提高10%以上，</div><div>再设置 sync_binlog = 0, 改变不明显。</div><div>再设置 thread_cache_size = 64，改变不明显。</div><div>再设置 innodb_buffer_pool_size = 64G，再上面基础上又提高了将近一倍，达到 tps: 2866</div><div><br/></div><div>用 Mysql master所在的机器作为客户端，lo（127.0.0.1）的网卡流量跑到2G多（原来的客户端是千兆网卡），性能又提高了一倍以上，tps达到6735.16，CPU才用到40%多。</div><div><br/></div><div>tidb_32x100w_256thread 每节点一个tikv（共三个） 4*sysbench 1*tidb tps:2779，只相当于PingCap结果4577的60%。TiDB所在的机器CPU占用达80%以上。</div><div><br/></div><div>升级到 5.7.1-TiDB-v1.1.0-beta-5-gba04a34 后性能有下降（单TiDB server)：2473，</div><div>在v1.1.0-beta-5下采用4个TiDB Server，性能达到 4852，性能已经超过 PingCap的测试报告，再考虑到v1.1.0-beta版性能下降的因素，起码在这种测试条件组合下，性能指标满意。</div><div>单纯TiDB Server的机器CPU占用50%多，TiDB + TiKV的机器CPU占用将近80%。</div><div><br/></div><div>每个节点新增一个TiKV实例，tps最终结果 3911，因为最后1分多钟性能总是严重下降。经过较长时间的稳定后，性能也比单TiKV要低。</div><div><br/></div><div>*. PingCap 的测试报告</div><div><a href="https://github.com/pingcap/docs-cn/blob/master/benchmark/sysbench.md">https://github.com/pingcap/docs-cn/blob/master/benchmark/sysbench.md</a></div><div><br/></div><div>end</div><div><br/></div></div></span>
</div></body></html> 